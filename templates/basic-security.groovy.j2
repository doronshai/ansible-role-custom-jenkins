#!groovy
import hudson.security.*
import hudson.model.*
import jenkins.model.*
import jenkins.security.plugins.ldap.FromGroupSearchLDAPGroupMembershipStrategy
import jenkins.security.plugins.ldap.LDAPGroupMembershipStrategy
import jenkins.model.IdStrategy
import org.jenkinsci.plugins.*
import hudson.model.AbstractDescribableImpl
import hudson.plugins.active_directory.* 

def instance = Jenkins.getInstance()

// disable signup
def hudsonRealm = new HudsonPrivateSecurityRealm(false)
{% for account in cj_local_admin_users %}
    hudsonRealm.createAccount('{{ account.username }}', '{{ account.password }}')
{% endfor %}
{% for account in cj_local_regular_users %}
    hudsonRealm.createAccount('{{ account.username }}', '{{ account.password }}')
{% endfor %}
instance.setSecurityRealm(hudsonRealm)
instance.save()

def strategy = new hudson.security.ProjectMatrixAuthorizationStrategy()
{% for account in cj_local_admin_users %}
    strategy.add(Jenkins.ADMINISTER, "{{ account.username }}")
{% endfor %}
    {% for account in cj_local_regular_users %}
    //strategy.add(hudson.model.View.READ, "{{ account.username }}")
    //strategy.add(hudson.model.Item.READ, "{{ account.username }}")
    strategy.add(Jenkins.READ, "{{ account.username }}")
{% endfor %}
{% if cj_allow_anon_read is defined %}
    strategy.add(hudson.model.View.READ, 'anonymous')
    strategy.add(hudson.model.Item.READ, 'anonymous')
    strategy.add(Jenkins.READ, 'anonymous')
{% endif %}

instance.setAuthorizationStrategy(strategy)

{% if activedirectory.enabled == true %}  

    instance = Jenkins.getInstance();
   
    def ActiveDirectoryDomain adDomain = new ActiveDirectoryDomain("corp.amdocs.com");
    def domains = new ArrayList<ActiveDirectoryDomain>();
    domains.add(adDomain);

    def securityRealm = new ActiveDirectorySecurityRealm( 
    "", //                              domain
    domains, //                         domains
    "", //                              site
    "", //                              bindName
    "", //                              bindPassword
    "", //                              server
    GroupLookupStrategy.RECURSIVE, //   groupLookupStrategy
    false, //                           removeIrrelevantGroups
    false,  //                           customDomain
    null,  //                           cache
    true,  //                           startTls
    "TRUST_ALL_CERTIFICATES")  //       tlsConfiguration

    println(securityRealm.domains)

    instance.setSecurityRealm(securityRealm) 
    instance.save()
{% endif %}